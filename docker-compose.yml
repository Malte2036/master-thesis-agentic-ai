name: master-thesis-agentic-ai-production

services:
  # --- Database (official MariaDB) ---
  mariadb:
    image: mariadb:10.11
    command:
      [
        '--character-set-server=utf8mb4',
        '--collation-server=utf8mb4_unicode_ci',
      ]
    environment:
      MYSQL_DATABASE: moodle
      MYSQL_USER: moodle
      MYSQL_PASSWORD: moodlepass # <<< change
      MYSQL_ROOT_PASSWORD: rootpass # <<< change
    volumes:
      - ./docker_data/moodle/mariadb_data_official:/var/lib/mysql
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'mysqladmin ping -h 127.0.0.1 -u$${MYSQL_USER} -p$${MYSQL_PASSWORD} || exit 1',
        ]
      interval: 10s
      timeout: 5s
      retries: 20

  # --- One-time initializer: prepare code/data + run CLI install (no web UI) ---
  moodle-init:
    image: moodlehq/moodle-php-apache:8.3-bullseye
    depends_on:
      mariadb:
        condition: service_healthy
    command:
      - /bin/sh
      - -c
      - |
        set -e

        # 1) Ensure code present (clone if ./moodle is empty)
        if [ -z "$(ls -A /var/www/html 2>/dev/null)" ]; then
          echo "[init] Cloning Moodle core (MOODLE_405_STABLE)..."
          git clone --depth=1 --branch MOODLE_405_STABLE https://github.com/moodle/moodle.git /var/www/html
        fi

        # 2) Ensure moodledata exists and has correct perms (www-data = 33)
        mkdir -p /var/www/moodledata
        chown -R 33:33 /var/www/moodledata
        # Optional: allow plugin installs via UI later
        chown -R 33:33 /var/www/html

        # 3) If not installed (no config.php), run non-interactive CLI install
        if [ ! -f /var/www/html/config.php ]; then
          echo "[init] Running Moodle CLI installer (no web UI)..."
          php /var/www/html/admin/cli/install.php \
            --chmod=2777 \
            --lang=en \
            --wwwroot=http://localhost:8080 \
            --dataroot=/var/www/moodledata \
            --dbtype=mariadb \
            --dbhost=mariadb \
            --dbport=3306 \
            --dbname=moodle \
            --dbuser=moodle \
            --dbpass=moodlepass \
            --fullname="Master Thesis Agentic AI" \
            --shortname="MTAI" \
            --adminuser=admin \
            --adminpass=Test123! \
            --adminemail=admin@example.com \
            --agree-license \
            --non-interactive
          echo "[init] Install complete."
        else
          echo "[init] config.php exists; skipping install."
        fi

        # 4) Done; container exits (one-shot)
    volumes:
      - ./moodle:/var/www/html
      - ./docker_data/moodle/moodle_content_data:/var/www/moodledata
    # Needs git for first-time clone
    # Install minimal git if absent, but this image already has it.
    # If your host already has ./moodle with code, the clone step is skipped.

  # --- Moodle web (Apache/PHP) ---
  moodle:
    image: moodlehq/moodle-php-apache:8.3-bullseye
    depends_on:
      mariadb:
        condition: service_healthy
      moodle-init:
        condition: service_completed_successfully
    ports:
      - '8080:80'
    volumes:
      - ./moodle:/var/www/html
      - ./docker_data/moodle/moodle_content_data:/var/www/moodledata
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsS http://127.0.0.1/ || exit 1']
      interval: 15s
      timeout: 5s
      retries: 20

  # --- Cron: runs every minute ---
  moodle-cron:
    image: moodlehq/moodle-php-apache:8.3-bullseye
    depends_on:
      mariadb:
        condition: service_healthy
      moodle-init:
        condition: service_completed_successfully
    entrypoint: ['/bin/sh', '-lc']
    command: >
      'while :; do php /var/www/html/admin/cli/cron.php; sleep 60; done'
    volumes:
      - ./moodle:/var/www/html
      - ./docker_data/moodle/moodle_content_data:/var/www/moodledata
